import { error, readFile, rootDir, writeFile } from "../utils";

const filePath = rootDir("./config/proxy.ts");

export async function updateProxy(data: { name: string }) {
  let code = readFile(filePath);

  const regex = /const\s+value\s*=\s*['"]([^'"]+)['"]/;
  if (regex.test(code)) {
    code = code.replace(regex, `const value = '${data.name}'`);
  }

  writeFile(filePath, code);
}

export function getProxyTarget(proxy: any) {
  const code = readFile(filePath);

  const regex = /const\s+value\s*=\s*['"]([^'"]+)['"]/;
  const match = code.match(regex);

  if (match) {
    const value = match[1];

    try {
      const { target, rewrite } = proxy[`/${value}/`];
      return target + rewrite(`/${value}`);
    } catch (err) {
      error(`[cool-proxy] Error：${value} → ` + filePath);
      return "";
    }
  }
}
